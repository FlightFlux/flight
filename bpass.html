<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Boarding Pass Scanner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script type="module">
    import { BrowserMultiFormatReader } from 'https://cdn.jsdelivr.net/npm/@zxing/browser@0.0.10/+esm';

    let codeReader;
    let scanActive = false;

    function parseBCBP(data) {
      try {
        // Extract data using standard BCBP format
        const name = data.substring(2, 22).trim();
        const pnr = data.substring(22, 29).trim();
        const from = data.substring(30, 33).trim();
        const to = data.substring(33, 36).trim();
        const airline = data.substring(36, 39).trim();
        const flight = data.substring(39, 43).trim();
        const date = data.substring(44, 47).trim();
        const seat = data.substring(48, 52).trim();
        const status = data.substring(58, 59).trim();

        // Convert Julian date to calendar date
        const year = new Date().getFullYear();
        const julianDate = parseInt(date);
        const startOfYear = new Date(year, 0, 0);
        const calendarDate = new Date(startOfYear.setDate(julianDate));
        const formattedDate = calendarDate.toLocaleDateString();

        return { 
          name, 
          pnr, 
          from, 
          to, 
          airline, 
          flight, 
          date: formattedDate,
          seat, 
          status 
        };
      } catch (error) {
        console.error("Error parsing barcode:", error);
        document.getElementById('status-msg').textContent = 'Error parsing barcode data';
        return null;
      }
    }

    function toggleScan() {
      const videoElement = document.getElementById('video');
      const toggleBtn = document.getElementById('toggle-btn');
      const statusMsg = document.getElementById('status-msg');

      if (scanActive) {
        // Stop scanning
        if (codeReader) {
          codeReader.reset();
          codeReader = null;
        }
        videoElement.style.display = "none";
        toggleBtn.textContent = "Start Scan";
        statusMsg.textContent = "Scanner stopped";
        scanActive = false;
      } else {
        // Start scanning
        startScan();
        toggleBtn.textContent = "Stop Scan";
        scanActive = true;
      }
    }

    async function startScan() {
      const videoElement = document.getElementById('video');
      const statusMsg = document.getElementById('status-msg');
      
      statusMsg.textContent = 'Activating camera...';
      videoElement.style.display = "block";
      
      codeReader = new BrowserMultiFormatReader();

      try {
        // In the older version, we directly use decodeFromVideoDevice with a null deviceId
        // to use the default camera
        await codeReader.decodeFromVideoDevice(null, videoElement, (result, err) => {
          if (result) {
            handleScanResult(result);
          } else if (err && err.name !== 'NotFoundException') {
            console.error(err);
            statusMsg.textContent = 'Error reading barcode';
          }
        });
        
        statusMsg.textContent = 'Camera ready. Point at barcode...';
        
        // Hide camera selection for now since we're using the default camera
        document.getElementById('camera-select').style.display = 'none';
      } catch (err) {
        console.error(err);
        statusMsg.textContent = 'Error accessing camera';
        document.getElementById('toggle-btn').textContent = "Start Scan";
        scanActive = false;
      }
    }

    function handleScanResult(result) {
      const barcodeData = result.text;
      document.getElementById('raw').textContent = barcodeData;
      
      // Play success sound
      document.getElementById('success-sound').play().catch(e => console.log('Sound play prevented by browser'));
      
      // Vibrate on mobile devices
      if (navigator.vibrate) {
        navigator.vibrate(200);
      }
      
      if (barcodeData.length > 20) {  // Basic validation check
        const parsed = parseBCBP(barcodeData);
        if (parsed) {
          fillBoardingPassInfo(parsed);
          document.getElementById('status-msg').textContent = 'Scan complete!';
          
          // Save to history
          saveToHistory(parsed);
          updateHistoryDisplay();
        }
      } else {
        document.getElementById('status-msg').textContent = 'Invalid barcode format';
      }
    }

    function fillBoardingPassInfo(data) {
      document.getElementById('name').textContent = data.name;
      document.getElementById('pnr').textContent = data.pnr;
      document.getElementById('flight').textContent = `${data.airline} ${data.flight}`;
      document.getElementById('route').textContent = `${data.from} → ${data.to}`;
      document.getElementById('date').textContent = data.date;
      document.getElementById('seat').textContent = data.seat;
      document.getElementById('status').textContent = data.status === '1' ? 'Checked-in' : 'Not Checked-in';
      
      document.getElementById('results-section').style.display = 'block';
      document.getElementById('info-card').classList.add('highlight');
      
      // Remove highlight effect after 2 seconds
      setTimeout(() => {
        document.getElementById('info-card').classList.remove('highlight');
      }, 2000);
    }

    function saveToHistory(data) {
      let history = JSON.parse(localStorage.getItem('boardingPassHistory') || '[]');
      
      // Add timestamp
      data.timestamp = new Date().toISOString();
      
      // Check if already exists by PNR and flight
      const exists = history.some(item => 
        item.pnr === data.pnr && 
        item.airline === data.airline && 
        item.flight === data.flight
      );
      
      if (!exists) {
        history.unshift(data);  // Add to beginning
        
        // Keep only latest 10 items
        if (history.length > 10) {
          history = history.slice(0, 10);
        }
        
        localStorage.setItem('boardingPassHistory', JSON.stringify(history));
      }
    }

    function updateHistoryDisplay() {
      const historyList = document.getElementById('history-list');
      const history = JSON.parse(localStorage.getItem('boardingPassHistory') || '[]');
      
      historyList.innerHTML = '';
      
      if (history.length === 0) {
        historyList.innerHTML = '<div class="empty-history">No history yet</div>';
        return;
      }
      
      history.forEach(item => {
        const historyItem = document.createElement('div');
        historyItem.className = 'history-item';
        historyItem.innerHTML = `
          <div class="history-main">
            <div class="history-flight">${item.airline} ${item.flight}</div>
            <div class="history-route">${item.from} → ${item.to}</div>
          </div>
          <div class="history-details">
            <div>${item.pnr}</div>
            <div>${item.seat}</div>
          </div>
        `;
        
        historyItem.addEventListener('click', () => {
          fillBoardingPassInfo(item);
        });
        
        historyList.appendChild(historyItem);
      });
    }

    function clearHistory() {
      if (confirm('Clear all scanning history?')) {
        localStorage.removeItem('boardingPassHistory');
        updateHistoryDisplay();
      }
    }

    function toggleHistory() {
      const historySection = document.getElementById('history-section');
      if (historySection.style.display === 'none' || !historySection.style.display) {
        historySection.style.display = 'block';
        updateHistoryDisplay();
      } else {
        historySection.style.display = 'none';
      }
    }

    // Export functions to window
    window.toggleScan = toggleScan;
    window.clearHistory = clearHistory;
    window.toggleHistory = toggleHistory;
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      updateHistoryDisplay();
    });
  </script>

  <style>
    :root {
      --primary-color: #0066cc;
      --secondary-color: #e6f2ff;
      --text-color: #333;
      --light-text: #666;
      --border-radius: 12px;
      --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #f8f9fa;
      color: var(--text-color);
      padding: 16px;
      max-width: 500px;
      margin: 0 auto;
      line-height: 1.5;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    h1 {
      font-size: 24px;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--primary-color);
    }
    
    button {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: var(--border-radius);
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: background 0.2s, transform 0.1s;
    }
    
    button:active {
      transform: scale(0.98);
    }
    
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .scan-container {
      background: white;
      border-radius: var(--border-radius);
      padding: 16px;
      box-shadow: var(--box-shadow);
      margin-bottom: 16px;
    }
    
    .camera-controls {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 12px;
    }
    
    #status-msg {
      color: var(--light-text);
      font-size: 14px;
      text-align: center;
      margin-top: 8px;
    }
    
    #video {
      width: 100%;
      border-radius: var(--border-radius);
      border: 2px solid var(--primary-color);
      margin-top: 12px;
      display: none;
      background: #000;
    }
    
    #camera-select {
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      display: none;
    }
    
    #results-section {
      display: none;
    }
    
    .info-card {
      background: white;
      border-radius: var(--border-radius);
      padding: 16px;
      box-shadow: var(--box-shadow);
      margin-bottom: 16px;
      border: 2px solid transparent;
      transition: border-color 0.3s;
    }
    
    .info-card.highlight {
      border-color: var(--primary-color);
    }
    
    .info-row {
      display: flex;
      margin-bottom: 8px;
      align-items: baseline;
    }
    
    .info-row:last-child {
      margin-bottom: 0;
    }
    
    .info-label {
      font-weight: 600;
      font-size: 14px;
      color: var(--light-text);
      min-width: 70px;
    }
    
    .info-value {
      font-size: 16px;
      font-weight: 500;
    }
    
    .divider {
      height: 1px;
      background: #eee;
      margin: 12px 0;
    }
    
    .raw-section {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px dashed #eee;
    }
    
    .raw-label {
      font-size: 12px;
      color: var(--light-text);
    }
    
    #raw {
      font-family: monospace;
      font-size: 12px;
      color: #888;
      word-break: break-all;
      margin-top: 4px;
    }
    
    .buttons {
      display: flex;
      gap: 8px;
      margin-top: 16px;
    }
    
    .btn-secondary {
      background: #f1f3f5;
      color: var(--text-color);
    }
    
    .history-container {
      background: white;
      border-radius: var(--border-radius);
      padding: 16px;
      box-shadow: var(--box-shadow);
      margin-bottom: 16px;
    }
    
    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .history-title {
      font-size: 18px;
      font-weight: 500;
    }
    
    .history-item {
      padding: 12px;
      border-radius: 8px;
      background: #f8f9fa;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .history-item:hover {
      background: var(--secondary-color);
    }
    
    .history-main {
      display: flex;
      flex-direction: column;
    }
    
    .history-flight {
      font-weight: 500;
    }
    
    .history-route {
      font-size: 14px;
      color: var(--light-text);
    }
    
    .history-details {
      text-align: right;
      font-size: 14px;
      color: var(--light-text);
    }
    
    .empty-history {
      text-align: center;
      padding: 16px;
      color: var(--light-text);
    }
    
    .footer {
      text-align: center;
      margin-top: 24px;
      font-size: 12px;
      color: #999;
    }
    
    @media (max-width: 400px) {
      body {
        padding: 12px;
      }
      
      .buttons {
        flex-direction: column;
      }
    }
    
    @keyframes pulse {
      0% { border-color: transparent; }
      50% { border-color: var(--primary-color); }
      100% { border-color: transparent; }
    }
  </style>
</head>
<body>
  <header>
    <h1>✈️ Boarding Pass Scanner</h1>
  </header>
  
  <div class="scan-container">
    <div class="camera-controls">
      <button id="toggle-btn" onclick="toggleScan()">Start Scan</button>
      <select id="camera-select" aria-label="Select camera"></select>
    </div>
    
    <div id="status-msg">Tap "Start Scan" to begin</div>
    <video id="video" autoplay muted playsinline></video>
  </div>
  
  <div id="results-section">
    <div id="info-card" class="info-card">
      <div class="info-row">
        <div class="info-label">Name:</div>
        <div id="name" class="info-value">—</div>
      </div>
      <div class="info-row">
        <div class="info-label">PNR:</div>
        <div id="pnr" class="info-value">—</div>
      </div>
      <div class="info-row">
        <div class="info-label">Flight:</div>
        <div id="flight" class="info-value">—</div>
      </div>
      <div class="info-row">
        <div class="info-label">Route:</div>
        <div id="route" class="info-value">—</div>
      </div>
      <div class="info-row">
        <div class="info-label">Date:</div>
        <div id="date" class="info-value">—</div>
      </div>
      <div class="info-row">
        <div class="info-label">Seat:</div>
        <div id="seat" class="info-value">—</div>
      </div>
      <div class="info-row">
        <div class="info-label">Status:</div>
        <div id="status" class="info-value">—</div>
      </div>
      
      <div class="raw-section">
        <div class="raw-label">Raw Barcode:</div>
        <div id="raw">—</div>
      </div>
    </div>
    
    <div class="buttons">
      <button onclick="toggleHistory()" class="btn-secondary">View History</button>
    </div>
  </div>
  
  <div id="history-section" class="history-container" style="display: none;">
    <div class="history-header">
      <div class="history-title">Scan History</div>
      <button onclick="clearHistory()" class="btn-secondary">Clear</button>
    </div>
    <div id="history-list"></div>
  </div>
  
  <audio id="success-sound" src="data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjI5LjEwMAAAAAAAAAAAAAAA//tQwAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAASAAAeMwAUFBQUFBQUFBQUFBQUFBQUFBQUFCkpKSkpKSkpKSkpKSkpKSkpKSkpKSkpKT4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj5TU1NTU1NTU1NTU1NTU1NTU1NTU1NTU1NTaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGh3d3d3d3d3d3d3d3d3d3d3d3d3d3d3d3d3d3d3goKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXrq6urq6urq6urq6urq6urq6urq6urq6urq6urq6urq6u//tQxAADwAABpAAAACAAADSAAAAETEFNRTMuOTkuNVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV" preload="auto"></audio>
  
  <div class="footer">
    Scan your boarding pass barcode to extract information. Works with standard BCBP format.
  </div>
</body>
</html>
