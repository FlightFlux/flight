<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Airline Staff Portal</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#0063c6">
    <meta name="description" content="Essential tools for airline staff - flight tracking, airport info, and quick links">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AA Staff Portal">
    <meta name="application-name" content="AA Staff Portal">
    
    <!-- Base64 Icons -->
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48dGV4dCB5PSIuOWVtIiBmb250LXNpemU9IjkwIj7inJc8L3RleHQ+PC9zdmc+">
    <link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAMAAAAKE/YAAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAAJcEhZcwAADsMAAA7DAcdvqGQAAABFUExURUxpcQBjxgBjxgBjxgBjxgBjxgBjxgBjxgBjxgBjxgBjxgBjxgBjxgBjxgBjxjqL0XOm25vF6LjT7tHi89vo9vP3+jQoS0cAAAAKdFJOUwC9P0n//////4ArQaSHAAAFVklEQVR42u2c63abMBCFhYkvYGOb93/VWhqBJQFG2/Sf7cxZa1pIyuYbzQVptEejbvnOVzG///yVLDlQOVA5UDlQOVA5UDlQOVA5UDlQOVA5UDlQOVA5UDlQOVA5UDlQOVA5UDlQ3xc0j1xXzhuXdSCfbRnDt4C+UbPUlYuaJlXTLpfLhf5M7V/UOxQHMx4fG/puodrSqkttMWxwt9BoEOxtQ/8UNHK7g40baPCJNg39U9Afpm0nE7WY1ULjq7z4bUMfXdSoywxQrzb0zbSqgyZUOm5oPo7vX+ygcUeVQ2cW2urVQI/7qQx14I5+aUDXXTqcLDQqx6aNPEBv5fCdQZsR1I6hkTi20KwH6FE5eunwgB7H9xvoSTnwBG166P4MdDe+jzEIwDhoDnWAPjvoaXzrqO2G06ChHB50B30eNKOXtfG9sRQDja9RB2jUARodwwaafbaPxndYOXrwDR3Gg37FQTMHPQ7v6/b4Xjf2u3L0v4N+Ax2g4aFb6IU0jmX70T2/KofuoMMEeqoc0NFNo/o9vnUL4xN0gJ5VjvVtNFWmfW0c0bR9xNW/k3JU76CnyhE6P6b7HvpYkS6TdECnQc+Vw6Zxe/UX0JGD6M1VDts/Z+O7csqxUTncl1UzM75b6NfK8blyhC42Ht9bA51TOTaUY3KnK4et3s74HhaNVQ78uwfoluYDdBblfkIRdbFufE/KUcVBLyrHp8pRbcX3BvpcOXLiO1E5cqCxZjAPGrO+Vw7XwK5Hd+KiYVaNr/EdlMNVjkn98qDj45ud9c9Vju6D+C49tR0/0GrlcEf3JB1ZlcPVuGp8I75XlWNdOSbl2FaOXOi08c0QoAtUD38q+Qydpxx4qXlKVo5M6HB6oDq6B+mc+HYrx9aiYVo5DuJbuXzl8BXSPGh0NV3V3Lzc+YyTt2goUT+YUY580xA7t62ND1T14n20csRBLyuHDvGdAT1XDpwdTE2sG99T5QgXjRLlYM54KFSO5kLQG5WjGt8JAxw7NnrQY/D4/hk6bdGQXjT+Xzl84jtzyvEKdKZy5JuGStaPwsrBXOXYUI5Z5ZgqR96ikVI5CrYcuFPLcdA2vlaUo8ZoWHECnbho5CrHoRz0ZuVwE3mJ+O7HdxnoROUYJpXDVeO6mnRjp9D6jc5UGnT+ohHGdy50rnLMlKMkdKZyRKCTs86t8V1eOfzlTkl8T5VjOsFSlYMVVI7TTei1yqFtfB+BzlOOpTROLRoB+gh0nnLMKsfR+C5YOQ5A2x4a2pGsHLPI2KrRG8rh1g9VOUoqx9vKsaocJZUjfcrxb+jTKoeLbyPpHKGV41Dl2K4c85RjVTlOqxxHobOUY2F8Hy0cx5XjoHIsKMdUOSTlG6uHE6BXKsdmfK9XDreJpSYtdAr0eJJlTTkixnekchxXjlnlCCfYJZRjXjlAHaNOUA6I4HUztg9UDjEcRGcrh6ocRys0KkfR+N6qHIdMQ7PKEYePquuPQc+VI055rHKcVzlmJ1hmleNw5dhWDqcckxFQOeJJsKYcx05gzivH+fEdqRxRk54qR+XiuzZ0rnKcVjni2/hWzlAOZvbGiXKcVjni0KgcrBzRUShRDmFnfG8px3nl2KwccWg5vg/dZkFnKEfpytFExvdSOcaEKFU56qrKgU5Rjvj4TlGOwpXDHK0cSeM7XTnyKseacoQbMV3uolG6cvwKelbulKocpU9g1u/SfjG6S1YOvVnjKz+lK8e38Z88mFUOedVnQWrjL4cVhtaLpJuqVQj6yC+JFP0pkaI/tlL0526K/mCQoj9tpOiPNyn6E1iK/liYoj+rpugPlv0FLbCwJ/8+G/MAAAAASUVORK5CYII=">
    
    <!-- Inline Manifest (properly escaped JSON) -->
    <link rel="manifest" id="manifest-placeholder">
    
    <!-- External CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Inline CSS -->
    <style>
        :root {
            --primary-color: #0063c6;
            --primary-dark: #004d9e;
            --primary-light: #e6f0ff;
            --accent-color: #e40046;
            --accent-dark: #b80039;
            --text-color: #333333;
            --background-color: #f8fafc;
            --card-color: #ffffff;
            --border-radius: 12px;
            --box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --transition: all 0.2s ease;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
        }

        /* Dark Mode Variables */
        .dark-mode {
            --text-color: #f1f5f9;
            --background-color: #0f172a;
            --card-color: #1e293b;
            --box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            --primary-light: #1a365d;
        }

        /* Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            padding: env(safe-area-inset-top, 10px) env(safe-area-inset-right, 10px) env(safe-area-inset-bottom, 10px) env(safe-area-inset-left, 10px);
            max-width: 100%;
            overflow-x: hidden;
            min-height: 100vh;
            transition: background-color 0.3s ease;
        }

        .container {
            max-width: 540px;
            margin: 0 auto;
            transition: all 0.3s ease;
        }

        /* Header Styles */
        .header-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .logo-container {
            display: flex;
            align-items: center;
        }

        .logo-text {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-color);
            letter-spacing: -0.5px;
        }

        .logo-icon {
            color: var(--accent-color);
            margin-right: 5px;
            font-size: 1.2rem;
        }

        /* Toggle Switches */
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle-group {
            display: flex;
            align-items: center;
        }

        .toggle-label {
            font-size: 0.7rem;
            margin-left: 4px;
            color: var(--text-color);
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--accent-color);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(18px);
        }

        /* Time Display */
        .time-display {
            background-color: var(--card-color);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 12px;
            margin-bottom: 12px;
            border: 1px solid rgba(0, 99, 198, 0.08);
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
        }

        .time-block {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .time-block.utc {
            align-items: flex-end;
        }

        .time-label {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 2px;
        }

        .time-value {
            font-weight: 500;
        }

        /* Cards */
        .mini-card, .card {
            background-color: var(--card-color);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            border: 1px solid rgba(0, 99, 198, 0.08);
            transition: var(--transition);
        }

        .mini-card {
            padding: 12px;
            margin-bottom: 12px;
        }

        .card {
            padding: 16px;
            margin-bottom: 16px;
        }

        .mini-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
        }

        .mini-title i {
            margin-right: 7px;
            font-size: 0.8rem;
            color: var(--accent-color);
        }

        h2 {
            font-size: 1.1rem;
            margin-bottom: 12px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            font-weight: 600;
        }

        h2 i {
            margin-right: 8px;
            color: var(--accent-color);
        }

        /* Forms */
        .compact-form {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .input-group {
            display: flex;
            flex: 1;
        }

        .airline-select {
            width: 70px;
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
            border-right: none;
        }

        .input-group input {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
            border-left: none;
        }

        .search-row {
            display: flex;
            align-items: center;
            margin-top: 6px;
        }

        .adv-search-link {
            font-size: 0.75rem;
            color: var(--primary-color);
            text-decoration: none;
            display: flex;
            align-items: center;
            margin-left: auto;
        }

        .adv-search-link i {
            margin-right: 3px;
            font-size: 0.7rem;
        }

        .adv-search-link:hover {
            text-decoration: underline;
        }

        /* Form Elements */
        input, select, button {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.85rem;
            transition: var(--transition);
        }

        input, select {
            background-color: #f8fafc;
            color: #1e293b;
        }

        .dark-mode input, .dark-mode select {
            background-color: #334155;
            color: white;
            border-color: #475569;
        }

        .compact-input {
            width: 100%;
            min-width: 0;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 99, 198, 0.1);
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
            min-width: 50px;
        }

        button i {
            margin-right: 4px;
        }

        button:hover, button:active {
            background-color: var(--primary-dark);
        }

        /* Quick Links */
        .quick-links {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .link-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: var(--primary-light);
            color: var(--primary-color);
            text-decoration: none;
            padding: 12px 5px;
            border-radius: var(--border-radius);
            text-align: center;
            font-size: 0.8rem;
            font-weight: 500;
            transition: var(--transition);
            height: 100%;
            border: 1px solid rgba(0, 99, 198, 0.1);
        }

        .link-item i {
            font-size: 1.3rem;
            margin-bottom: 6px;
        }

        .link-item:hover, .link-item:active {
            background-color: var(--primary-color);
            color: white;
        }

        .dark-mode .link-item {
            border: 1px solid rgba(255, 255, 255, 0.05);
            background-color: #1a365d;
        }

        /* Offline Indicator */
        .offline-indicator {
            background-color: var(--warning-color);
            color: white;
            padding: 8px 12px;
            border-radius: var(--border-radius);
            margin-bottom: 12px;
            font-size: 0.8rem;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .offline-indicator i {
            margin-right: 5px;
        }

        .offline .offline-indicator {
            display: flex;
        }

        /* Footer */
        .footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 16px;
            color: #64748b;
            font-size: 0.8rem;
        }

        .update-badge {
            background-color: var(--accent-color);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            cursor: pointer;
        }

        .hidden {
            display: none;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: var(--card-color);
            padding: 20px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            position: relative;
        }

        .close-modal {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 1.5rem;
            cursor: pointer;
        }

        h3 {
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .form-group input, .form-group select {
            width: 100%;
        }

        .btn-primary {
            width: 100%;
            padding: 10px;
            font-weight: 600;
        }

        /* Small screen mode - only hides extras, doesn't change width */
        .small-screen-mode .container {
            height: auto;
            overflow-y: visible;
            border: none;
            border-radius: 0;
            padding: 10px;
        }

        /* Hide everything except essentials in small screen mode */
        .small-screen-mode .card,
        .small-screen-mode .footer {
            display: none !important;
        }

        /* Keep normal spacing for the visible elements */
        .small-screen-mode .time-display {
            margin-bottom: 10px;
        }

        .small-screen-mode .mini-card {
            margin-bottom: 10px;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        /* Media Queries */
        @media (max-width: 480px) {
            .quick-links {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Notification */
        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            color: white;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1000;
            max-width: 80%;
            text-align: center;
        }

        .notification.show {
            opacity: 1;
        }

        .notification.success {
            background-color: var(--success-color);
        }

        .notification.error {
            background-color: var(--error-color);
        }

        .notification.warning {
            background-color: var(--warning-color);
        }

        .notification.info {
            background-color: var(--primary-color);
        }

        /* Icon Loading Spinner */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px 0;
        }

        .loading i {
            margin-right: 8px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* PWA Install Button */
        .install-button {
            background-color: var(--accent-color);
            color: white;
            padding: 10px 16px;
            border-radius: var(--border-radius);
            margin: 10px auto;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            cursor: pointer;
            font-weight: 500;
            box-shadow: var(--box-shadow);
        }

        .install-button i {
            margin-right: 8px;
        }

        .install-button:hover {
            background-color: var(--accent-dark);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header with Toggles -->
        <div class="header-row">
            <div class="logo-container">
                <i class="fas fa-plane logo-icon"></i>
                <div class="logo-text">Airline Staff Portal</div>
            </div>
            <div class="toggle-container">
                <div class="toggle-group">
                    <label class="toggle-switch" title="Small Screen Mode">
                        <input type="checkbox" id="small-screen-toggle">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="toggle-label">3.6"</span>
                </div>
                
                <div class="toggle-group">
                    <label class="toggle-switch" title="Dark Mode">
                        <input type="checkbox" id="dark-mode-toggle">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="toggle-label">Dark</span>
                </div>
            </div>
        </div>

        <!-- Install PWA Button -->
        <button id="install-pwa" class="install-button">
            <i class="fas fa-download"></i> Install App
        </button>

        <!-- Time Display -->
        <div class="time-display">
            <div class="time-block local">
                <div class="time-label">LOCAL</div>
                <div class="time-value" id="local-time"></div>
                <div class="time-value" id="local-date"></div>
            </div>
            <div class="time-block utc">
                <div class="time-label">UTC</div>
                <div class="time-value" id="utc-time"></div>
                <div class="time-value" id="utc-date"></div>
            </div>
        </div>

        <!-- Offline Mode Indicator -->
        <div id="offline-indicator" class="offline-indicator">
            <i class="fas fa-wifi-slash"></i> Offline Mode - Some features may not be available
        </div>

        <!-- Condensed Flight Tracker -->
        <div class="mini-card">
            <div class="mini-title"><i class="fas fa-plane-departure"></i>Track Flight</div>
            <form id="flight-tracker-form" class="compact-form">
                <div class="input-group">
                    <select id="airline-select" class="airline-select">
                        <option value="AAL">AA</option>
                        <option value="DAL">DL</option>
                        <option value="UAL">UA</option>
                        <option value="SWA">WN</option>
                    </select>
                    <input type="number" id="flight-number" class="compact-input" placeholder="Flight #" pattern="[0-9]*" inputmode="numeric">
                </div>
                <select id="tracking-service">
                    <option value="flightaware">FA</option>
                    <option value="flightradar24">FR24</option>
                </select>
                <button type="submit" aria-label="Track Flight"><i class="fas fa-search"></i>Go</button>
            </form>
        </div>

        <!-- Airport Lookup -->
        <div class="mini-card">
            <div class="mini-title"><i class="fas fa-info-circle"></i>Airport Info</div>
            <form id="airport-info-form" class="compact-form">
                <input type="text" id="airport-code" class="compact-input" placeholder="Airport Code (e.g. DFW)" maxlength="3">
                <button type="submit" aria-label="Get Airport Info"><i class="fas fa-plane-arrival"></i>Go</button>
            </form>
        </div>

        <!-- Condensed Search -->
        <div class="mini-card">
            <div class="mini-title"><i class="fas fa-search"></i>Search Google</div>
            <form id="google-search-form">
                <div class="compact-form">
                    <input type="text" name="q" placeholder="Search query..." id="google-search-box" class="compact-input" autocomplete="off">
                    <button type="submit" aria-label="Search Google"><i class="fas fa-arrow-right"></i>Go</button>
                </div>
                <div class="search-row">
                    <a href="https://www.google.com/advanced_search" target="_blank" class="adv-search-link">
                        <i class="fas fa-cog"></i>Advanced
                    </a>
                </div>
            </form>
        </div>

        <!-- Quick Links -->
        <div class="card">
            <h2><i class="fas fa-link"></i>Quick Links</h2>
            <div class="quick-links">
                <a href="https://webmail.aa.com" class="link-item" target="_blank">
                    <i class="fas fa-envelope"></i>
                    <span>AA Email</span>
                </a>
                <a href="https://teams.microsoft.com/v2/" class="link-item" target="_blank">
                    <i class="fas fa-users"></i>
                    <span>Teams</span>
                </a>
                <a href="https://spteam.aa.com/sites/D5B" class="link-item" target="_blank">
                    <i class="fas fa-building"></i>
                    <span>ABR DFW</span>
                </a>
                <a href="https://airportal.aa.com/AirPortalWeb/HTML/dashboard/dashboard.html" class="link-item" target="_blank">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>AirPortal</span>
                </a>
                <a href="https://newjetnet.aa.com/" class="link-item" target="_blank">
                    <i class="fas fa-id-badge"></i>
                    <span>Jetnet</span>
                </a>
                <a href="https://tools.crew.aa.com/losa/" class="link-item" target="_blank">
                    <i class="fas fa-shield-alt"></i>
                    <span>LOSA</span>
                </a>
                <a href="https://flightaware.com/live/fleet/AAL" class="link-item" target="_blank">
                    <i class="fas fa-plane"></i>
                    <span>Fleet</span>
                </a>
                <a href="https://www.faa.gov/air_traffic/weather/asos" class="link-item" target="_blank">
                    <i class="fas fa-cloud-sun"></i>
                    <span>Weather</span>
                </a>
                <a href="#" class="link-item" id="add-link-btn">
                    <i class="fas fa-plus"></i>
                    <span>Add Link</span>
                </a>
            </div>
        </div>

        <!-- App Status -->
        <div class="footer">
            <span>Airline Staff Portal • v1.3.0</span>
            <span id="update-available" class="update-badge hidden">Update Available</span>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification" class="notification"></div>

    <!-- Modal for adding custom links -->
    <div id="add-link-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h3>Add Custom Link</h3>
            <form id="add-link-form">
                <div class="form-group">
                    <label for="link-name">Name:</label>
                    <input type="text" id="link-name" required>
                </div>
                <div class="form-group">
                    <label for="link-url">URL:</label>
                    <input type="url" id="link-url" required placeholder="https://">
                </div>
                <div class="form-group">
                    <label for="link-icon">Icon:</label>
                    <select id="link-icon">
                        <option value="fa-link">Link</option>
                        <option value="fa-plane">Plane</option>
                        <option value="fa-clipboard">Clipboard</option>
                        <option value="fa-calendar">Calendar</option>
                        <option value="fa-user">User</option>
                        <option value="fa-map">Map</option>
                        <option value="fa-cog">Settings</option>
                    </select>
                </div>
                <button type="submit" class="btn-primary">Add Link</button>
            </form>
        </div>
    </div>

    <!-- Inline JavaScript -->
    <script>
        // Constants
        const APP_VERSION = '1.3.0';
        const CACHE_VERSION = 'airline-staff-portal-v1.3.0';
        const CUSTOM_LINKS_KEY = 'airline-staff-portal-custom-links';
        
        // Create the manifest
        const manifestData = {
            name: "Airline Staff Portal",
            short_name: "AA Staff",
            description: "Essential tools for airline staff",
            id: "/index.html",
            start_url: "./index.html",
            display: "standalone",
            background_color: "#0063c6",
            theme_color: "#0063c6",
            orientation: "portrait-primary",
            icons: [
                {
                    src: "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48dGV4dCB5PSIuOWVtIiBmb250LXNpemU9IjkwIj7inJc8L3RleHQ+PC9zdmc+",
                    sizes: "192x192",
                    type: "image/svg+xml",
                    purpose: "any"
                },
                {
                    src: "data:image/png;base64,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",
                    sizes: "512x512",
                    type: "image/png",
                    purpose: "any maskable"
                }
            ],
            shortcuts: [
                {
                    name: "Track Flight",
                    short_name: "Flight",
                    description: "Track a flight quickly",
                    url: "./index.html?action=track_flight",
                    icons: [{ 
                        src: "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48dGV4dCB5PSIuOWVtIiBmb250LXNpemU9IjkwIj7inJc8L3RleHQ+PC9zdmc+", 
                        sizes: "192x192" 
                    }]
                },
                {
                    name: "Airport Info",
                    short_name: "Airport",
                    description: "Look up airport information",
                    url: "./index.html?action=airport_info",
                    icons: [{ 
                        src: "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48dGV4dCB5PSIuOWVtIiBmb250LXNpemU9IjkwIj7wn5OG8J+TiTwvdGV4dD48L3N2Zz4=", 
                        sizes: "192x192" 
                    }]
                }
            ],
            scope: "./",
            related_applications: [],
            prefer_related_applications: false,
            categories: ["utilities", "productivity"]
        };

        // Create Blob and Object URL for manifest
        const manifestBlob = new Blob([JSON.stringify(manifestData)], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(manifestBlob);
        document.getElementById('manifest-placeholder').href = manifestURL;

        // DOM elements
        const localTimeElement = document.getElementById('local-time');
        const localDateElement = document.getElementById('local-date');
        const utcTimeElement = document.getElementById('utc-time');
        const utcDateElement = document.getElementById('utc-date');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const smallScreenToggle = document.getElementById('small-screen-toggle');
        const flightTrackerForm = document.getElementById('flight-tracker-form');
        const googleSearchForm = document.getElementById('google-search-form');
        const airportInfoForm = document.getElementById('airport-info-form');
        const addLinkBtn = document.getElementById('add-link-btn');
        const addLinkModal = document.getElementById('add-link-modal');
        const closeModalBtn = document.querySelector('.close-modal');
        const addLinkForm = document.getElementById('add-link-form');
        const notificationElement = document.getElementById('notification');
        const installButton = document.getElementById('install-pwa');

        // PWA install event
        let deferredPrompt;
        
        // Initialize application
        function initApp() {
            // Initialize clock
            updateTime();
            setInterval(updateTime, 1000);
            
            // Load saved preferences
            loadSavedPreferences();
            
            // Load custom links
            loadCustomLinks();
            
            // Initialize listeners
            initEventListeners();
            
            // Check network status and set up listeners
            updateOnlineStatus();
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);

            // Register service worker
            registerServiceWorker();

            // Process URL parameters (for shortcuts)
            processUrlParams();
            
            // Setup PWA installation
            setupPWAInstall();
        }

        // Setup PWA install prompt
        function setupPWAInstall() {
            // Listen for the beforeinstallprompt event
            window.addEventListener('beforeinstallprompt', (e) => {
                // Prevent Chrome 67 and earlier from automatically showing the prompt
                e.preventDefault();
                // Stash the event so it can be triggered later
                deferredPrompt = e;
                // Update UI to notify the user they can add to home screen
                installButton.style.display = 'flex';
            });

            // Installation button click handler
            installButton.addEventListener('click', async () => {
                if (!deferredPrompt) {
                    return;
                }
                // Show the install prompt
                deferredPrompt.prompt();
                // Wait for the user to respond to the prompt
                const { outcome } = await deferredPrompt.userChoice;
                // Optionally, send analytics event with outcome of user choice
                console.log(`User response to the install prompt: ${outcome}`);
                // We've used the prompt, and can't use it again, throw it away
                deferredPrompt = null;
                // Hide the install button
                installButton.style.display = 'none';
            });

            // Listen for successful install
            window.addEventListener('appinstalled', (evt) => {
                // Log install to analytics
                console.log('INSTALL: Success');
                // Hide the install button
                installButton.style.display = 'none';
                // Show notification
                showNotification('App successfully installed!', 'success');
            });
        }

        // Process URL parameters
        function processUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const action = urlParams.get('action');
            
            if (action === 'track_flight') {
                document.getElementById('flight-number').focus();
            } else if (action === 'airport_info') {
                document.getElementById('airport-code').focus();
            }
        }

        // Update time display
        function updateTime() {
            const now = new Date();
            
            // Format local time
            localTimeElement.textContent = now.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            localDateElement.textContent = now.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric' 
            });
            
            // Format UTC time
            utcTimeElement.textContent = now.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit', 
                timeZone: 'UTC' 
            });
            
            utcDateElement.textContent = now.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                timeZone: 'UTC' 
            });
        }

        // Load user preferences
        function loadSavedPreferences() {
            const darkMode = localStorage.getItem('darkMode') === 'true';
            const smallScreenMode = localStorage.getItem('smallScreenMode') === 'true';
            
            if (darkMode) {
                darkModeToggle.checked = true;
                document.documentElement.classList.add('dark-mode');
            }
            
            if (smallScreenMode) {
                smallScreenToggle.checked = true;
                document.body.classList.add('small-screen-mode');
            }

            // Check if we need to update if version has changed
            const savedVersion = localStorage.getItem('appVersion');
            if (savedVersion !== APP_VERSION) {
                localStorage.setItem('appVersion', APP_VERSION);
                if (savedVersion) {
                    // Show update notification only if this is not first install
                    showNotification(`Updated to version ${APP_VERSION}`, 'info');
                }
            }
        }

        // Initialize event listeners
        function initEventListeners() {
            // Dark mode toggle
            darkModeToggle.addEventListener('change', function() {
                document.documentElement.classList.toggle('dark-mode');
                localStorage.setItem('darkMode', darkModeToggle.checked);
            });

            // Small screen toggle
            smallScreenToggle.addEventListener('change', function() {
                document.body.classList.toggle('small-screen-mode');
                localStorage.setItem('smallScreenMode', smallScreenToggle.checked);
            });

            // Flight tracker form
            flightTrackerForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const flightNumber = document.getElementById('flight-number').value;
                const airlineCode = document.getElementById('airline-select').value;
                const trackingService = document.getElementById('tracking-service').value;
                
                if (!flightNumber) {
                    showNotification('Please enter a flight number', 'error');
                    return;
                }
                
                let url;
                if (trackingService === 'flightaware') {
                    url = `https://flightaware.com/live/flight/${airlineCode}${flightNumber}`;
                } else {
                    url = `https://www.flightradar24.com/data/flights/${airlineCode.toLowerCase()}${flightNumber}`;
                }
                
                window.open(url, '_blank');
                showNotification('Opening flight tracker', 'success');
            });

            // Google search form
            googleSearchForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const searchQuery = document.getElementById('google-search-box').value;
                
                if (!searchQuery) {
                    showNotification('Please enter a search query', 'error');
                    return;
                }
                
                window.open(`https://www.google.com/search?q=${encodeURIComponent(searchQuery)}`, '_blank');
            });

            // Airport info form
            airportInfoForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const airportCode = document.getElementById('airport-code').value.toUpperCase();
                
                if (!airportCode || airportCode.length !== 3) {
                    showNotification('Please enter a valid 3-letter airport code', 'error');
                    return;
                }
                
                // Redirect to FlightAware airport page
                const flightAwareUrl = `https://flightaware.com/live/airport/${airportCode}`;
                window.open(flightAwareUrl, '_blank');
                showNotification(`Opening ${airportCode} on FlightAware`, 'success');
            });

            // Add link button
            addLinkBtn.addEventListener('click', function(e) {
                e.preventDefault();
                openAddLinkModal();
            });

            // Close modal
            closeModalBtn.addEventListener('click', closeAddLinkModal);
            window.addEventListener('click', function(e) {
                if (e.target === addLinkModal) {
                    closeAddLinkModal();
                }
            });

            // Add link form
            addLinkForm.addEventListener('submit', function(e) {
                e.preventDefault();
                addCustomLink();
            });

            // Update badge click handler
            document.getElementById('update-available').addEventListener('click', function() {
                // Force reload from server, not cache
                window.location.reload(true);
            });
        }

        // Load custom links from localStorage
        function loadCustomLinks() {
            try {
                const customLinks = JSON.parse(localStorage.getItem(CUSTOM_LINKS_KEY)) || [];
                
                // Add custom links to the grid before the "Add Link" button
                customLinks.forEach(link => {
                    addLinkToDOM(link);
                });
            } catch (error) {
                console.error('Error loading custom links:', error);
                showNotification('Error loading your custom links', 'error');
            }
        }

        // Add a custom link to the DOM
        function addLinkToDOM(link) {
            const linkElement = document.createElement('a');
            linkElement.href = link.url;
            linkElement.className = 'link-item';
            linkElement.target = '_blank';
            linkElement.dataset.id = link.id;
            
            linkElement.innerHTML = `
                <i class="fas ${link.icon}"></i>
                <span>${link.name}</span>
            `;
            
            // Add a delete option that shows on long press or right-click
            linkElement.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                if (confirm(`Remove "${link.name}" from your quick links?`)) {
                    removeCustomLink(link.id);
                    linkElement.remove();
                }
            });
            
            // Add the link before the "Add Link" button
            const quickLinksContainer = document.querySelector('.quick-links');
            quickLinksContainer.insertBefore(linkElement, addLinkBtn);
        }

        // Open the add link modal
        function openAddLinkModal() {
            addLinkModal.style.display = 'flex';
            document.getElementById('link-name').focus();
        }

        // Close the add link modal
        function closeAddLinkModal() {
            addLinkModal.style.display = 'none';
            addLinkForm.reset();
        }

        // Add a custom link
        function addCustomLink() {
            const name = document.getElementById('link-name').value.trim();
            const url = document.getElementById('link-url').value.trim();
            const icon = document.getElementById('link-icon').value;
            
            if (!name || !url) {
                showNotification('Please fill out all fields', 'error');
                return;
            }
            
            // Validate URL format
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                showNotification('URL must start with http:// or https://', 'error');
                return;
            }
            
            // Create link object
            const newLink = {
                id: Date.now().toString(),
                name,
                url,
                icon
            };
            
            // Save to localStorage
            try {
                const customLinks = JSON.parse(localStorage.getItem(CUSTOM_LINKS_KEY)) || [];
                customLinks.push(newLink);
                localStorage.setItem(CUSTOM_LINKS_KEY, JSON.stringify(customLinks));
                
                // Add to DOM
                addLinkToDOM(newLink);
                
                // Close modal
                closeAddLinkModal();
                
                showNotification('Link added successfully', 'success');
            } catch (error) {
                console.error('Error saving custom link:', error);
                showNotification('Error saving link', 'error');
            }
        }

        // Remove a custom link
        function removeCustomLink(id) {
            try {
                const customLinks = JSON.parse(localStorage.getItem(CUSTOM_LINKS_KEY)) || [];
                const updatedLinks = customLinks.filter(link => link.id !== id);
                localStorage.setItem(CUSTOM_LINKS_KEY, JSON.stringify(updatedLinks));
                
                showNotification('Link removed', 'success');
            } catch (error) {
                console.error('Error removing custom link:', error);
                showNotification('Error removing link', 'error');
            }
        }

        // Update online status
        function updateOnlineStatus() {
            if (navigator.onLine) {
                document.body.classList.remove('offline');
                // If coming back online, check if we need to sync
                if (window.serviceWorkerRegistration && navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({
                        type: 'ONLINE_AGAIN'
                    });
                }
            } else {
                document.body.classList.add('offline');
                showNotification('You are now offline. Some features may be limited.', 'warning');
            }
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification';
            notification.classList.add(type);
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Create and Register Service Worker
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                // Create the Service Worker content
                const swContent = `
                    // Service Worker for Airline Staff Portal PWA
                    const CACHE_NAME = '${CACHE_VERSION}';
                    const APP_SHELL = [
                        './',
                        './index.html',
                        'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css',
                        'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/webfonts/fa-solid-900.woff2'
                    ];

                    // Install event handler - cache the app shell
                    self.addEventListener('install', event => {
                        console.log('[Service Worker] Installing Service Worker...');
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then(cache => {
                                    console.log('[Service Worker] Caching App Shell');
                                    return cache.addAll(APP_SHELL);
                                })
                                .then(() => {
                                    console.log('[Service Worker] Successfully installed');
                                    return self.skipWaiting();
                                })
                        );
                    });

                    // Activate event handler - clean up old caches
                    self.addEventListener('activate', event => {
                        console.log('[Service Worker] Activating Service Worker...');
                        event.waitUntil(
                            caches.keys()
                                .then(keyList => {
                                    return Promise.all(keyList.map(key => {
                                        if (key !== CACHE_NAME) {
                                            console.log('[Service Worker] Removing old cache', key);
                                            return caches.delete(key);
                                        }
                                    }));
                                })
                                .then(() => {
                                    console.log('[Service Worker] Claiming clients');
                                    return self.clients.claim();
                                })
                        );
                        return self.clients.claim();
                    });

                    // Fetch event handler - serve from cache, fallback to network
                    self.addEventListener('fetch', event => {
                        // Skip cross-origin requests
                        if (!event.request.url.startsWith(self.location.origin) && 
                            !event.request.url.includes('cdnjs.cloudflare.com')) {
                            return;
                        }
                        
                        event.respondWith(
                            caches.match(event.request)
                                .then(response => {
                                    if (response) {
                                        // Return cached response
                                        return response;
                                    }
                                    
                                    // If not in cache, fetch from network
                                    return fetch(event.request)
                                        .then(networkResponse => {
                                            // Don't cache third-party resources
                                            if (!event.request.url.includes('google.com') && 
                                                !event.request.url.includes('flightaware.com') && 
                                                !event.request.url.includes('flightradar24.com')) {
                                                // Clone the response before using it
                                                const responseToCache = networkResponse.clone();
                                                caches.open(CACHE_NAME)
                                                    .then(cache => {
                                                        cache.put(event.request, responseToCache);
                                                    });
                                            }
                                            return networkResponse;
                                        })
                                        .catch(() => {
                                            // For navigation requests, return the offline page
                                            if (event.request.mode === 'navigate') {
                                                return caches.match('./index.html');
                                            }
                                            // Return a default response for other requests
                                            return new Response('Network unavailable', {
                                                status: 503,
                                                statusText: 'Service Unavailable',
                                                headers: new Headers({
                                                    'Content-Type': 'text/plain'
                                                })
                                            });
                                        });
                                })
                        );
                    });

                    // Message event handler
                    self.addEventListener('message', event => {
                        if (event.data.action === 'skipWaiting') {
                            self.skipWaiting();
                        }
                    });
                `;

                // Create a blob from the service worker content
                const swBlob = new Blob([swContent], {type: 'application/javascript'});
                
                // Create a URL for the blob
                const swURL = URL.createObjectURL(swBlob);
                
                // Register the service worker using the blob URL
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register(swURL)
                        .then(registration => {
                            console.log('Service Worker registered with scope:', registration.scope);
                            window.serviceWorkerRegistration = registration;
                            
                            // Check for updates
                            registration.addEventListener('updatefound', () => {
                                const newWorker = registration.installing;
                                console.log('Service Worker update found!');
                                document.getElementById('update-available').classList.remove('hidden');
                                
                                // Reload to update when clicked
                                document.getElementById('update-available').addEventListener('click', () => {
                                    if (newWorker) {
                                        newWorker.postMessage({ action: 'skipWaiting' });
                                    }
                                    window.location.reload();
                                });
                            });

                            // Handle service worker updates
                            navigator.serviceWorker.addEventListener('controllerchange', () => {
                                console.log('Service Worker controller changed!');
                            });
                        })
                        .catch(error => {
                            console.error('Service Worker registration failed:', error);
                        });
                });
            }
        }

        // Initialize the app when the DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>